# This workflow publishes the package to npm when a GitHub release is created
# Uses OIDC trusted publishing with provenance for secure, tokenless authentication
# For more information see: https://docs.npmjs.com/generating-provenance-statements

name: TurboDocx n8n Node - NPM Release

on:
  release:
    types: [created]  # Trigger when a new release is published on GitHub

permissions:
  id-token: write    # Required for OIDC trusted publishing
  contents: read     # Required to checkout code

jobs:
  # Build and validate the package before publishing
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      # Install dependencies with clean install (respects package-lock.json exactly)
      - run: npm ci

      # Build the TypeScript code
      - run: npm run build

      # Run linter to validate code quality
      - run: npm run lint

  # Publish the package to npm registry (only runs if build job passes)
  publish-npm:
    needs: build  # Wait for build to pass before publishing
    runs-on: ubuntu-latest
    permissions:
      id-token: write    # Required for OIDC trusted publishing
      contents: read     # Required to checkout code
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/  # Configure npm registry for publishing

      # Install dependencies
      - run: npm ci

      # Build the production bundle
      - run: npm run build

      # Publish to npm with provenance (OIDC trusted publishing - no token required)
      - run: npm publish --access public --provenance --ignore-scripts
